<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encrypted British File Processor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        textarea, input[type="file"], button {
            display: block;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Encrypted British File Processor</h1>

    <h2>Encode Markdown into .british</h2>
    <textarea id="markdownInput" rows="8" cols="50" placeholder="Enter Markdown text here..."></textarea>
    <button id="encodeButton">Encode to .british</button>

    <h2>Decode .british File</h2>
    <input type="file" id="fileInput" accept=".british">
    <button id="decodeButton">Decode File</button>
    <pre id="output" style="white-space: pre-wrap; background: #f4f4f4; padding: 10px;"></pre>

    <script>
        const SIGNATURE = "BRSH"; // Plaintext signature
        const encoder = new TextEncoder();
        const decoder = new TextDecoder();

        // AES encryption setup
        const cryptoKey = encoder.encode("SuperSecretKey1234567890123456"); // 32-byte key for AES-256
        const iv = encoder.encode("Initialization123"); // 16-byte IV for AES

        async function encrypt(data) {
            const encrypted = await crypto.subtle.encrypt(
                { name: "AES-CBC", iv },
                await crypto.subtle.importKey("raw", cryptoKey, { name: "AES-CBC" }, false, ["encrypt"]),
                data
            );
            return new Uint8Array(encrypted);
        }

        async function decrypt(data) {
            const decrypted = await crypto.subtle.decrypt(
                { name: "AES-CBC", iv },
                await crypto.subtle.importKey("raw", cryptoKey, { name: "AES-CBC" }, false, ["decrypt"]),
                data
            );
            return new Uint8Array(decrypted);
        }

        // Encode Markdown into .british
        document.getElementById("encodeButton").addEventListener("click", async () => {
            const markdown = document.getElementById("markdownInput").value;
            if (!markdown) {
                alert("Please enter Markdown text.");
                return;
            }

            const content = encoder.encode(markdown);
            const signature = encoder.encode(SIGNATURE);

            // Encrypt signature and content
            const encryptedData = await encrypt(new Uint8Array([...signature, ...content]));
            const length = encryptedData.length;

            // Construct file header (2 bytes for length)
            const header = new Uint8Array([length & 0xFF, (length >> 8) & 0xFF]);

            // Combine header and encrypted data
            const fileData = new Blob([header, encryptedData]);

            // Download as .british file
            const link = document.createElement("a");
            link.href = URL.createObjectURL(fileData);
            link.download = "output.british";
            link.click();
        });

        // Decode .british file
        document.getElementById("decodeButton").addEventListener("click", async () => {
            const fileInput = document.getElementById("fileInput");
            if (!fileInput.files.length) {
                alert("Please upload a .british file.");
                return;
            }

            const file = fileInput.files[0];
            const buffer = await file.arrayBuffer();
            const data = new Uint8Array(buffer);

            // Read header
            const length = data[0] + (data[1] << 8);
            const encryptedData = data.slice(2, 2 + length);

            try {
                // Decrypt data
                const decryptedData = await decrypt(encryptedData);
                const signature = decoder.decode(decryptedData.slice(0, 4));
                const content = decoder.decode(decryptedData.slice(4));

                // Verify signature
                if (signature !== SIGNATURE) {
                    alert("Invalid .british file.");
                    return;
                }

                // Display decoded content
                document.getElementById("output").textContent = content;
            } catch (error) {
                alert("Failed to decrypt file. Ensure the file is valid.");
            }
        });
    </script>
</body>
</html>
